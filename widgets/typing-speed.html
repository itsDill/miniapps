<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Advanced Typing Speed Test - WPM Calculator & Accuracy Tracker | iowidgets
    </title>
    <meta
      name="description"
      content="Professional typing speed test with real-time WPM calculation, accuracy tracking, multiple difficulty levels, custom text modes, progress analytics, and detailed performance statistics. Improve your typing skills!"
    />
    <meta
      name="keywords"
      content="typing speed test, WPM test, words per minute, typing accuracy, typing practice, keyboard test, typing tutor, typing game, typing skills, typing speed calculator"
    />
    <link
      rel="canonical"
      href="https://iowidgets.com/widgets/typing-speed.html"
    />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta
      property="og:title"
      content="Advanced Typing Speed Test - WPM & Accuracy Tracker"
    />
    <meta
      property="og:description"
      content="Test your typing speed with real-time WPM calculation, accuracy tracking, multiple difficulty levels, and detailed performance analytics. Perfect for improving typing skills!"
    />
    <meta
      property="og:url"
      content="https://iowidgets.com/widgets/typing-speed.html"
    />
    <meta
      property="og:image"
      content="https://iowidgets.com/assets/og-typing-speed.png"
    />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="Advanced Typing Speed Test - WPM & Accuracy Tracker"
    />
    <meta
      name="twitter:description"
      content="Test your typing speed with multiple difficulty levels, custom text modes, and detailed performance analytics. Track your progress and improve!"
    />
    <meta
      name="twitter:image"
      content="https://iowidgets.com/assets/og-typing-speed.png"
    />

    <!-- Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Advanced Typing Speed Test",
        "description": "Professional typing speed test with real-time WPM calculation and accuracy tracking",
        "url": "https://iowidgets.com/widgets/typing-speed.html",
        "applicationCategory": "UtilityApplication",
        "operatingSystem": "Any",
        "offers": {
          "@type": "Offer",
          "price": "0",
          "priceCurrency": "USD"
        },
        "featureList": [
          "Real-time WPM calculation",
          "Accuracy tracking",
          "Multiple difficulty levels",
          "Custom text mode",
          "Progress analytics",
          "Performance statistics",
          "Test history tracking",
          "5 color themes",
          "Keyboard shortcuts",
          "Export results (CSV/JSON)"
        ]
      }
    </script>
    <style>
      :root {
        --primary: #4facfe;
        --primary-dark: #3b9ae1;
        --primary-light: #7ec4ff;
        --secondary: #00f2fe;
        --background: #ffffff;
        --surface: #f8f9fa;
        --text-primary: #1a1a1a;
        --text-secondary: #666666;
        --border: #e0e0e0;
        --shadow: rgba(0, 0, 0, 0.1);
        --shadow-lg: rgba(0, 0, 0, 0.2);
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #3b82f6;

        --spacing-xs: 0.5rem;
        --spacing-sm: 0.75rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --spacing-xl: 2rem;
        --spacing-2xl: 3rem;

        --font-size-xs: clamp(0.75rem, 2vw, 0.875rem);
        --font-size-sm: clamp(0.875rem, 2.5vw, 0.9375rem);
        --font-size-base: clamp(1rem, 3vw, 1.125rem);
        --font-size-lg: clamp(1.125rem, 3.5vw, 1.25rem);
        --font-size-xl: clamp(1.25rem, 4vw, 1.5rem);
        --font-size-2xl: clamp(1.5rem, 5vw, 2rem);
        --font-size-3xl: clamp(2rem, 6vw, 2.5rem);

        --radius-sm: 0.5rem;
        --radius-md: 0.75rem;
        --radius-lg: 1rem;
        --radius-xl: 1.5rem;

        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      [data-theme="blue"] {
        --primary: #3b82f6;
        --primary-dark: #2563eb;
        --primary-light: #60a5fa;
        --secondary: #93c5fd;
      }

      [data-theme="green"] {
        --primary: #10b981;
        --primary-dark: #059669;
        --primary-light: #34d399;
        --secondary: #6ee7b7;
      }

      [data-theme="purple"] {
        --primary: #a855f7;
        --primary-dark: #9333ea;
        --primary-light: #c084fc;
        --secondary: #d8b4fe;
      }

      [data-theme="orange"] {
        --primary: #f97316;
        --primary-dark: #ea580c;
        --primary-light: #fb923c;
        --secondary: #fdba74;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-md);
        color: var(--text-primary);
        line-height: 1.6;
        transition: var(--transition);
      }

      .container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: var(--radius-xl);
        padding: var(--spacing-xl);
        box-shadow: 0 20px 60px var(--shadow-lg),
          0 0 0 1px rgba(255, 255, 255, 0.5);
        max-width: 900px;
        width: 100%;
        animation: slideUp 0.5s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        flex-wrap: wrap;
        gap: var(--spacing-md);
      }

      h1 {
        font-size: var(--font-size-2xl);
        color: var(--text-primary);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .theme-selector {
        display: flex;
        gap: var(--spacing-xs);
        flex-wrap: wrap;
      }

      .theme-btn {
        width: 44px;
        height: 44px;
        border: 2px solid transparent;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: var(--transition);
        background: var(--color);
        position: relative;
      }

      .theme-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px var(--shadow);
      }

      .theme-btn.active {
        border-color: var(--text-primary);
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
      }

      .theme-btn:focus-visible {
        outline: 3px solid var(--primary);
        outline-offset: 2px;
      }

      .theme-btn[data-theme="cyan"] {
        --color: #4facfe;
      }
      .theme-btn[data-theme="blue"] {
        --color: #3b82f6;
      }
      .theme-btn[data-theme="green"] {
        --color: #10b981;
      }
      .theme-btn[data-theme="purple"] {
        --color: #a855f7;
      }
      .theme-btn[data-theme="orange"] {
        --color: #f97316;
      }

      .controls {
        display: flex;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-lg);
        flex-wrap: wrap;
        align-items: center;
      }

      .control-group {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        background: var(--surface);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        flex: 1;
        min-width: 200px;
      }

      .control-group label {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
        font-weight: 600;
        white-space: nowrap;
      }

      .control-group select {
        flex: 1;
        padding: var(--spacing-xs);
        border: 2px solid var(--border);
        border-radius: var(--radius-sm);
        font-size: var(--font-size-sm);
        font-family: inherit;
        background: white;
        cursor: pointer;
      }

      .control-group select:focus {
        outline: none;
        border-color: var(--primary);
      }

      .timer-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        padding: var(--spacing-lg);
        background: linear-gradient(
          135deg,
          var(--surface) 0%,
          rgba(79, 172, 254, 0.05) 100%
        );
        border-radius: var(--radius-lg);
        flex-wrap: wrap;
        gap: var(--spacing-md);
      }

      .timer {
        font-size: var(--font-size-3xl);
        font-weight: 700;
        color: var(--primary);
        font-variant-numeric: tabular-nums;
      }

      .progress-ring {
        position: relative;
        width: 80px;
        height: 80px;
      }

      .progress-ring-circle {
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
      }

      .text-display {
        background: var(--surface);
        padding: var(--spacing-xl);
        border-radius: var(--radius-lg);
        font-size: var(--font-size-lg);
        line-height: 2;
        margin-bottom: var(--spacing-lg);
        min-height: 180px;
        user-select: none;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        letter-spacing: 0.5px;
        border: 2px solid var(--border);
      }

      .text-display span {
        position: relative;
        transition: all 0.1s ease;
      }

      .text-display .correct {
        color: var(--success);
      }

      .text-display .incorrect {
        color: var(--danger);
        background: rgba(239, 68, 68, 0.1);
        border-radius: 3px;
      }

      .text-display .current {
        border-left: 3px solid var(--primary);
        animation: blink 1s infinite;
      }

      @keyframes blink {
        50% {
          border-color: transparent;
        }
      }

      .input-area {
        margin-bottom: var(--spacing-lg);
        display: none;
      }

      .input-area.visible {
        display: block;
      }

      textarea {
        width: 100%;
        padding: var(--spacing-md);
        border: 2px solid var(--border);
        border-radius: var(--radius-lg);
        font-size: var(--font-size-base);
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        resize: none;
        height: 120px;
        line-height: 1.6;
        transition: var(--transition);
      }

      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(79, 172, 254, 0.1);
      }

      textarea:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .tabs {
        display: flex;
        gap: var(--spacing-xs);
        margin-bottom: var(--spacing-lg);
        border-bottom: 2px solid var(--border);
        overflow-x: auto;
      }

      .tab {
        padding: var(--spacing-sm) var(--spacing-md);
        min-height: 44px;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: var(--font-size-sm);
        font-weight: 600;
        color: var(--text-secondary);
        transition: var(--transition);
        white-space: nowrap;
      }

      .tab:hover {
        color: var(--primary);
      }

      .tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }

      .tab:focus-visible {
        outline: 3px solid var(--primary);
        outline-offset: 2px;
      }

      .tab-content {
        display: none;
        animation: fadeIn 0.3s ease-out;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: var(--spacing-md);
      }

      .stat-card {
        background: linear-gradient(
          135deg,
          var(--surface) 0%,
          rgba(79, 172, 254, 0.05) 100%
        );
        padding: var(--spacing-lg);
        border-radius: var(--radius-lg);
        text-align: center;
        border: 2px solid transparent;
        transition: var(--transition);
      }

      .stat-card:hover {
        border-color: var(--primary);
        transform: translateY(-4px);
        box-shadow: 0 8px 24px var(--shadow);
      }

      .stat-value {
        font-size: var(--font-size-3xl);
        font-weight: 700;
        color: var(--primary);
        margin-bottom: var(--spacing-xs);
        font-variant-numeric: tabular-nums;
      }

      .stat-label {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn {
        min-width: 44px;
        min-height: 44px;
        padding: var(--spacing-md) var(--spacing-lg);
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-size: var(--font-size-base);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        white-space: nowrap;
        width: 100%;
      }

      .btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px var(--shadow);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn:focus-visible {
        outline: 3px solid var(--primary-light);
        outline-offset: 2px;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn-secondary {
        background: var(--surface);
        color: var(--text-primary);
      }

      .btn-secondary:hover {
        background: var(--border);
      }

      .history-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        max-height: 400px;
        overflow-y: auto;
      }

      .history-item {
        background: var(--surface);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        border: 2px solid var(--border);
        transition: var(--transition);
      }

      .history-item:hover {
        border-color: var(--primary);
        background: white;
      }

      .history-date {
        font-size: var(--font-size-xs);
        color: var(--text-secondary);
        margin-bottom: var(--spacing-xs);
      }

      .history-stats {
        display: flex;
        gap: var(--spacing-lg);
        font-size: var(--font-size-sm);
        flex-wrap: wrap;
      }

      .history-stat {
        display: flex;
        flex-direction: column;
      }

      .history-stat-value {
        font-size: var(--font-size-lg);
        font-weight: 700;
        color: var(--primary);
      }

      .history-stat-label {
        font-size: var(--font-size-xs);
        color: var(--text-secondary);
      }

      .export-section {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-lg);
        flex-wrap: wrap;
      }

      .empty-state {
        text-align: center;
        padding: var(--spacing-2xl);
        color: var(--text-secondary);
      }

      .empty-state-icon {
        font-size: var(--font-size-3xl);
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
      }

      @media (max-width: 640px) {
        .container {
          padding: var(--spacing-md);
        }

        header {
          flex-direction: column;
          align-items: flex-start;
        }

        .stats {
          grid-template-columns: repeat(2, 1fr);
        }

        .controls {
          flex-direction: column;
          align-items: stretch;
        }

        .control-group {
          min-width: 100%;
        }

        .timer-section {
          flex-direction: column;
          text-align: center;
        }

        .text-display {
          font-size: var(--font-size-base);
          padding: var(--spacing-md);
        }
      }

      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      @media (prefers-contrast: high) {
        .container {
          border: 3px solid var(--text-primary);
        }

        .stat-card,
        .history-item {
          border-width: 3px;
        }
      }

      @media print {
        body {
          background: white;
        }

        .container {
          box-shadow: none;
          padding: 0;
        }

        .controls,
        .export-section,
        .theme-selector,
        .tabs,
        .btn {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>
          <span aria-hidden="true">⌨️</span>
          Typing Speed Test
        </h1>
        <div class="theme-selector" role="group" aria-label="Theme selection">
          <button
            class="theme-btn active"
            data-theme="cyan"
            aria-label="Cyan theme"
            aria-pressed="true"
          ></button>
          <button
            class="theme-btn"
            data-theme="blue"
            aria-label="Blue theme"
            aria-pressed="false"
          ></button>
          <button
            class="theme-btn"
            data-theme="green"
            aria-label="Green theme"
            aria-pressed="false"
          ></button>
          <button
            class="theme-btn"
            data-theme="purple"
            aria-label="Purple theme"
            aria-pressed="false"
          ></button>
          <button
            class="theme-btn"
            data-theme="orange"
            aria-label="Orange theme"
            aria-pressed="false"
          ></button>
        </div>
      </header>

      <div class="controls">
        <div class="control-group">
          <label for="difficultySelect">Difficulty:</label>
          <select id="difficultySelect" aria-label="Select difficulty level">
            <option value="easy">Easy (30s)</option>
            <option value="medium" selected>Medium (60s)</option>
            <option value="hard">Hard (120s)</option>
          </select>
        </div>
        <div class="control-group">
          <label for="modeSelect">Mode:</label>
          <select id="modeSelect" aria-label="Select test mode">
            <option value="random" selected>Random Text</option>
            <option value="quotes">Famous Quotes</option>
            <option value="code">Code Snippets</option>
            <option value="custom">Custom Text</option>
          </select>
        </div>
      </div>

      <div class="timer-section">
        <div>
          <div class="timer" id="timer" role="timer" aria-live="polite">
            60s
          </div>
          <div
            style="
              font-size: var(--font-size-sm);
              color: var(--text-secondary);
              text-align: center;
            "
          >
            Time Remaining
          </div>
        </div>
        <svg class="progress-ring" width="80" height="80">
          <circle
            class="progress-ring-circle"
            stroke="var(--border)"
            stroke-width="8"
            fill="transparent"
            r="32"
            cx="40"
            cy="40"
          />
          <circle
            id="progressCircle"
            class="progress-ring-circle"
            stroke="var(--primary)"
            stroke-width="8"
            fill="transparent"
            r="32"
            cx="40"
            cy="40"
            stroke-dasharray="201 201"
            stroke-dashoffset="0"
          />
        </svg>
      </div>

      <div
        class="text-display"
        id="textDisplay"
        role="region"
        aria-label="Text to type"
      >
        <div class="empty-state">
          <div class="empty-state-icon">⌨️</div>
          <p>Click "Start Test" to begin typing</p>
        </div>
      </div>

      <div class="input-area" id="inputAreaContainer">
        <textarea
          id="inputArea"
          placeholder="Type the text above here..."
          aria-label="Type the displayed text here"
          disabled
        ></textarea>
      </div>

      <div class="tabs" role="tablist">
        <button
          class="tab active"
          data-tab="stats"
          role="tab"
          aria-selected="true"
          aria-controls="stats-panel"
        >
          Statistics
        </button>
        <button
          class="tab"
          data-tab="history"
          role="tab"
          aria-selected="false"
          aria-controls="history-panel"
        >
          History
        </button>
        <button
          class="tab"
          data-tab="export"
          role="tab"
          aria-selected="false"
          aria-controls="export-panel"
        >
          Export
        </button>
      </div>

      <main>
        <div
          id="stats-panel"
          class="tab-content active"
          role="tabpanel"
          aria-labelledby="stats-tab"
        >
          <div class="stats">
            <div class="stat-card">
              <div class="stat-value" id="wpm">0</div>
              <div class="stat-label">WPM</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="cpm">0</div>
              <div class="stat-label">CPM</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="accuracy">100</div>
              <div class="stat-label">% Accuracy</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="errors">0</div>
              <div class="stat-label">Errors</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="correctChars">0</div>
              <div class="stat-label">Correct</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalChars">0</div>
              <div class="stat-label">Total Chars</div>
            </div>
          </div>
        </div>

        <div
          id="history-panel"
          class="tab-content"
          role="tabpanel"
          aria-labelledby="history-tab"
        >
          <div id="historyList" class="history-list">
            <div class="empty-state">
              <div class="empty-state-icon">📊</div>
              <p>No test history yet</p>
              <p
                style="
                  font-size: var(--font-size-sm);
                  margin-top: var(--spacing-sm);
                "
              >
                Complete a test to see your results here
              </p>
            </div>
          </div>
        </div>

        <div
          id="export-panel"
          class="tab-content"
          role="tabpanel"
          aria-labelledby="export-tab"
        >
          <div class="export-section">
            <button
              class="btn"
              id="exportCsvBtn"
              aria-label="Export history as CSV"
            >
              <span aria-hidden="true">📊</span> Export CSV
            </button>
            <button
              class="btn"
              id="exportJsonBtn"
              aria-label="Export history as JSON"
            >
              <span aria-hidden="true">📋</span> Export JSON
            </button>
            <button
              class="btn btn-secondary"
              id="clearHistoryBtn"
              aria-label="Clear all history"
            >
              <span aria-hidden="true">🗑️</span> Clear History
            </button>
          </div>
        </div>
      </main>

      <button class="btn" id="startBtn" aria-label="Start typing test">
        <span aria-hidden="true">▶️</span> Start Test
      </button>
      <button
        class="btn"
        id="restartBtn"
        aria-label="Restart typing test"
        style="display: none"
      >
        <span aria-hidden="true">🔄</span> Restart Test
      </button>
    </div>
    <script>
      const textSets = {
        random: [
          "The quick brown fox jumps over the lazy dog near the riverbank while the sun sets behind the mountains.",
          "Programming is the art of telling another human what one wants the computer to do in a clear and precise manner.",
          "Practice makes perfect, but nobody is perfect, so why practice when you can just be awesome from the start?",
          "Type with precision and speed to master the keyboard effectively and improve your productivity every single day.",
          "Knowledge is power, and the ability to type quickly opens doors to unlimited information and communication.",
          "Every expert was once a beginner who refused to give up despite facing numerous challenges and setbacks.",
        ],
        quotes: [
          "The only way to do great work is to love what you do. - Steve Jobs",
          "Life is what happens when you're busy making other plans. - John Lennon",
          "The future belongs to those who believe in the beauty of their dreams. - Eleanor Roosevelt",
          "In the middle of difficulty lies opportunity. - Albert Einstein",
          "Success is not final, failure is not fatal: it is the courage to continue that counts. - Winston Churchill",
        ],
        code: [
          "function calculateSum(a, b) { return a + b; }",
          "const arr = [1, 2, 3].map(x => x * 2).filter(x => x > 2);",
          "if (condition) { console.log('true'); } else { console.log('false'); }",
          "class Person { constructor(name) { this.name = name; } }",
          "const fetchData = async () => { const res = await fetch(url); return res.json(); }",
        ],
      };

      let testText = "";
      let currentIndex = 0;
      let startTime = 0;
      let totalTime = 60;
      let timeLeft = 60;
      let interval;
      let errors = 0;
      let isTestActive = false;
      let history = [];
      let currentTheme = "cyan";

      function init() {
        loadSettings();
        setupEventListeners();
      }

      function setupEventListeners() {
        document
          .getElementById("startBtn")
          .addEventListener("click", startTest);
        document
          .getElementById("restartBtn")
          .addEventListener("click", startTest);
        document
          .getElementById("inputArea")
          .addEventListener("input", checkInput);

        document
          .getElementById("difficultySelect")
          .addEventListener("change", updateDifficulty);
        document
          .getElementById("modeSelect")
          .addEventListener("change", handleModeChange);

        document
          .getElementById("exportCsvBtn")
          .addEventListener("click", exportCsv);
        document
          .getElementById("exportJsonBtn")
          .addEventListener("click", exportJson);
        document
          .getElementById("clearHistoryBtn")
          .addEventListener("click", clearHistory);

        document.querySelectorAll(".theme-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            document.querySelectorAll(".theme-btn").forEach((b) => {
              b.classList.remove("active");
              b.setAttribute("aria-pressed", "false");
            });
            this.classList.add("active");
            this.setAttribute("aria-pressed", "true");
            currentTheme = this.dataset.theme;
            document.body.dataset.theme = currentTheme;
            saveSettings();
          });
        });

        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            const tabName = this.dataset.tab;
            document.querySelectorAll(".tab").forEach((t) => {
              t.classList.remove("active");
              t.setAttribute("aria-selected", "false");
            });
            document
              .querySelectorAll(".tab-content")
              .forEach((c) => c.classList.remove("active"));
            this.classList.add("active");
            this.setAttribute("aria-selected", "true");
            document.getElementById(`${tabName}-panel`).classList.add("active");
          });
        });

        document.addEventListener("keydown", handleKeyPress);
      }

      function handleKeyPress(e) {
        if (e.key === "Escape" && isTestActive) {
          endTest();
        }
      }

      function updateDifficulty() {
        const difficulty = document.getElementById("difficultySelect").value;
        if (difficulty === "easy") totalTime = 30;
        else if (difficulty === "medium") totalTime = 60;
        else if (difficulty === "hard") totalTime = 120;

        if (!isTestActive) {
          timeLeft = totalTime;
          document.getElementById("timer").textContent = timeLeft + "s";
        }
      }

      function handleModeChange() {
        const mode = document.getElementById("modeSelect").value;
        if (mode === "custom") {
          const customText = prompt(
            "Enter your custom text (min 50 characters):"
          );
          if (customText && customText.length >= 50) {
            textSets.custom = [customText];
          } else {
            alert("Custom text must be at least 50 characters long!");
            document.getElementById("modeSelect").value = "random";
          }
        }
      }

      function startTest() {
        const mode = document.getElementById("modeSelect").value;
        const texts = textSets[mode] || textSets.random;
        testText = texts[Math.floor(Math.random() * texts.length)];

        currentIndex = 0;
        errors = 0;
        timeLeft = totalTime;
        startTime = Date.now();
        isTestActive = true;

        document.getElementById("inputArea").value = "";
        document.getElementById("inputArea").disabled = false;
        document.getElementById("inputAreaContainer").classList.add("visible");
        document.getElementById("inputArea").focus();

        document.getElementById("startBtn").style.display = "none";
        document.getElementById("restartBtn").style.display = "inline-flex";

        displayText();
        resetStats();

        interval = setInterval(() => {
          timeLeft--;
          updateTimer();
          updateProgressRing();

          if (timeLeft === 0) {
            endTest();
          }
        }, 1000);

        announceToScreenReader("Test started. Start typing!");
      }

      function displayText() {
        const display = document.getElementById("textDisplay");
        display.innerHTML = testText
          .split("")
          .map((char, i) => {
            let className = "";
            const inputValue = document.getElementById("inputArea").value;

            if (i < currentIndex) {
              className = inputValue[i] === char ? "correct" : "incorrect";
            } else if (i === currentIndex) {
              className = "current";
            }

            const escapedChar =
              char === " "
                ? "&nbsp;"
                : char === "<"
                ? "&lt;"
                : char === ">"
                ? "&gt;"
                : char;
            return `<span class="${className}">${escapedChar}</span>`;
          })
          .join("");
      }

      function checkInput() {
        if (!isTestActive) return;

        const input = document.getElementById("inputArea").value;
        currentIndex = input.length;

        errors = 0;
        for (let i = 0; i < input.length; i++) {
          if (input[i] !== testText[i]) errors++;
        }

        displayText();
        updateStats();

        if (input.length === testText.length) {
          endTest();
        }
      }

      function updateTimer() {
        document.getElementById("timer").textContent = timeLeft + "s";
      }

      function updateProgressRing() {
        const circle = document.getElementById("progressCircle");
        const radius = 32;
        const circumference = 2 * Math.PI * radius;
        const progress = timeLeft / totalTime;
        const offset = circumference - progress * circumference;

        circle.style.strokeDasharray = `${circumference} ${circumference}`;
        circle.style.strokeDashoffset = offset;
      }

      function resetStats() {
        document.getElementById("wpm").textContent = "0";
        document.getElementById("cpm").textContent = "0";
        document.getElementById("accuracy").textContent = "100";
        document.getElementById("errors").textContent = "0";
        document.getElementById("correctChars").textContent = "0";
        document.getElementById("totalChars").textContent = "0";
      }

      function updateStats() {
        const elapsed = (Date.now() - startTime) / 1000 / 60;
        const input = document.getElementById("inputArea").value;

        // Words per minute
        const words = input
          .trim()
          .split(/\s+/)
          .filter((w) => w.length > 0).length;
        const wpm = elapsed > 0 ? Math.round(words / elapsed) : 0;

        // Characters per minute
        const cpm = elapsed > 0 ? Math.round(input.length / elapsed) : 0;

        // Accuracy
        const correctChars = currentIndex - errors;
        const accuracy =
          currentIndex > 0
            ? Math.round((correctChars / currentIndex) * 100)
            : 100;

        document.getElementById("wpm").textContent = wpm;
        document.getElementById("cpm").textContent = cpm;
        document.getElementById("accuracy").textContent = accuracy;
        document.getElementById("errors").textContent = errors;
        document.getElementById("correctChars").textContent = correctChars;
        document.getElementById("totalChars").textContent = currentIndex;
      }

      function endTest() {
        clearInterval(interval);
        isTestActive = false;
        document.getElementById("inputArea").disabled = true;
        updateStats();

        const result = {
          date: new Date().toISOString(),
          wpm: parseInt(document.getElementById("wpm").textContent),
          cpm: parseInt(document.getElementById("cpm").textContent),
          accuracy: parseInt(document.getElementById("accuracy").textContent),
          errors: errors,
          difficulty: document.getElementById("difficultySelect").value,
          mode: document.getElementById("modeSelect").value,
          totalChars: currentIndex,
        };

        history.unshift(result);
        if (history.length > 50) {
          history = history.slice(0, 50);
        }

        try {
          localStorage.setItem("typingSpeedHistory", JSON.stringify(history));
          updateHistoryDisplay();
        } catch (e) {
          console.error("Failed to save history:", e);
        }

        announceToScreenReader(
          `Test completed. ${result.wpm} words per minute, ${result.accuracy}% accuracy`
        );
      }

      function updateHistoryDisplay() {
        const historyList = document.getElementById("historyList");

        if (history.length === 0) {
          historyList.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">📊</div>
              <p>No test history yet</p>
              <p style="font-size: var(--font-size-sm); margin-top: var(--spacing-sm);">
                Complete a test to see your results here
              </p>
            </div>`;
          return;
        }

        historyList.innerHTML = history
          .map(
            (result, index) => `
          <div class="history-item">
            <div class="history-date">${new Date(
              result.date
            ).toLocaleString()} • ${result.difficulty} • ${result.mode}</div>
            <div class="history-stats">
              <div class="history-stat">
                <div class="history-stat-value">${result.wpm}</div>
                <div class="history-stat-label">WPM</div>
              </div>
              <div class="history-stat">
                <div class="history-stat-value">${result.cpm}</div>
                <div class="history-stat-label">CPM</div>
              </div>
              <div class="history-stat">
                <div class="history-stat-value">${result.accuracy}%</div>
                <div class="history-stat-label">Accuracy</div>
              </div>
              <div class="history-stat">
                <div class="history-stat-value">${result.errors}</div>
                <div class="history-stat-label">Errors</div>
              </div>
            </div>
          </div>
        `
          )
          .join("");
      }

      function exportCsv() {
        if (history.length === 0) {
          alert("No history to export!");
          return;
        }

        const headers = [
          "Date",
          "WPM",
          "CPM",
          "Accuracy",
          "Errors",
          "Difficulty",
          "Mode",
          "Total Chars",
        ];
        const rows = history.map((h) => [
          new Date(h.date).toLocaleString(),
          h.wpm,
          h.cpm,
          h.accuracy + "%",
          h.errors,
          h.difficulty,
          h.mode,
          h.totalChars,
        ]);

        const csv = [headers, ...rows].map((row) => row.join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        downloadFile(blob, `typing-speed-history-${Date.now()}.csv`);
        announceToScreenReader("History exported as CSV");
      }

      function exportJson() {
        if (history.length === 0) {
          alert("No history to export!");
          return;
        }

        const data = {
          history: history,
          exportDate: new Date().toISOString(),
          totalTests: history.length,
          averageWPM: Math.round(
            history.reduce((sum, h) => sum + h.wpm, 0) / history.length
          ),
          averageAccuracy: Math.round(
            history.reduce((sum, h) => sum + h.accuracy, 0) / history.length
          ),
          bestWPM: Math.max(...history.map((h) => h.wpm)),
        };

        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: "application/json" });
        downloadFile(blob, `typing-speed-history-${Date.now()}.json`);
        announceToScreenReader("History exported as JSON");
      }

      function downloadFile(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      function clearHistory() {
        if (confirm("Clear all test history?")) {
          history = [];
          localStorage.removeItem("typingSpeedHistory");
          updateHistoryDisplay();
          announceToScreenReader("History cleared");
        }
      }

      function saveSettings() {
        const settings = {
          theme: currentTheme,
          difficulty: document.getElementById("difficultySelect").value,
          mode: document.getElementById("modeSelect").value,
        };
        try {
          localStorage.setItem("typingSpeedSettings", JSON.stringify(settings));
        } catch (e) {
          console.error("Failed to save settings:", e);
        }
      }

      function loadSettings() {
        try {
          const savedSettings = localStorage.getItem("typingSpeedSettings");
          if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            currentTheme = settings.theme || "cyan";
            document.body.dataset.theme = currentTheme;

            if (settings.difficulty) {
              document.getElementById("difficultySelect").value =
                settings.difficulty;
              updateDifficulty();
            }

            if (settings.mode) {
              document.getElementById("modeSelect").value = settings.mode;
            }

            document.querySelectorAll(".theme-btn").forEach((btn) => {
              if (btn.dataset.theme === currentTheme) {
                btn.classList.add("active");
                btn.setAttribute("aria-pressed", "true");
              } else {
                btn.classList.remove("active");
                btn.setAttribute("aria-pressed", "false");
              }
            });
          }

          const savedHistory = localStorage.getItem("typingSpeedHistory");
          if (savedHistory) {
            history = JSON.parse(savedHistory);
            updateHistoryDisplay();
          }
        } catch (e) {
          console.error("Failed to load settings:", e);
        }
      }

      function announceToScreenReader(message) {
        const announcement = document.createElement("div");
        announcement.setAttribute("role", "status");
        announcement.setAttribute("aria-live", "polite");
        announcement.className = "sr-only";
        announcement.textContent = message;
        document.body.appendChild(announcement);

        setTimeout(() => {
          document.body.removeChild(announcement);
        }, 1000);
      }

      init();
    </script>
  </body>
</html>
